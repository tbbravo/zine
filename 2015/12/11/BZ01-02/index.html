<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>移动设备识别及贴吧应用 | 贴吧企业商业化团队周刊</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="alternative" href="/atom.xml" title="贴吧企业商业化团队周刊" type="application/atom+xml">
  <link rel="shortcut icon" href="/favicon.png">
  <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="/css/index.css" type="text/css">
  <link rel="stylesheet" href="/css/article.css" type="text/css">
</head>

<body class="index">
    <header id="header" class="weekly-header">
        <div class="header-inner clearfix">
            <h1 class="weekly-title">Bravo周刊</h1>
            <div class="weekly-meta">
                <p class="tswk-editor">本周编辑：<a href="baidu://message/?id=rorannf">晴文</a></p>
                <p class="tswk-reviewer">本周校审：<a href="baidu://message/?id=Yushuang_sys">玉双</a></p>
            </div>
        </div>
    </header>
    <div class="weekly-content clearfix">
        <article id="post-hack-in-localstorage" class="article article-type-post">
    <div class="article-meta">
        <a href="/2015/12/11/BZ01-02/" class="article-date">
        <time datetime="Fri Dec 11 2015 21:21:15 GMT+0800" itemprop="datePublished">2015-12-11</time>
        </a>
    </div>
    <div class="article-inner">
        <input type="hidden" class="isFancy">
        <header class="article-header">
            <h1 class="article-title" itemprop="name">
                移动设备识别及贴吧应用
            </h1>
        </header>
        <div class="article-info article-info-post">
            <div class="article-tag tagcloud">
                <ul class="article-tag-list">
                    
                        <li class="article-tag-list-item">
                            <a href="/tags/User-Agent/" title="User-Agent" class="article-tag-list-link" target="_blank" rel="external">User-Agent</a>
                        </li>
                    
                        <li class="article-tag-list-item">
                            <a href="/tags/原创/" title="原创" class="article-tag-list-link" target="_blank" rel="external">原创</a>
                        </li>
                    
                </ul>
            </div>
            <div class="clearfix"></div>
        </div>
        <div class="article-entry" itemprop="articleBody">
            <blockquote>
<p>本文主要介绍后端对移动设备的识别方法和方案，并详细介绍了贴吧的使用经验。</p>
</blockquote>
<p>来自<a href="https://github.com/crispgm" target="_blank" rel="external">crispgm</a>的原创<br><a id="more"></a></p>
<h2 id="u80CC_u666F"><a href="#u80CC_u666F" class="headerlink" title="背景"></a>背景</h2><p>随着移动时代的到来，移动上网用户的比例已经超过PC用户，其中移动浏览器的用户基数也得到了很大的提升，移动浏览器的访问也是用户的重要来源之一。这些用户通过移动端浏览器访问网页时，受限于网络状况、屏幕分辨率、操作交互方式和渲染能力等原因的影响，并不一定适用于平时专为PC浏览器设计的网页。</p>
<p>为此，许多网站会为移动web端做特别的优化。优化的方式有多种，其中，比较常见的几种方式是：</p>
<ol>
<li>在进入页面时初步识别，并提供切换功能，用户手动选择</li>
<li>采用响应式页面设计，单个页面适应全部终端设备</li>
<li>对用户访问进行设备识别，决定进入的网页类型</li>
</ol>
<p>其中，响应式页面设计方式并不依赖于主要基于屏幕分辨率和前端技术实现，并不依赖移动设备识别。而其它方式，则往往需要进行移动识别。</p>
<h2 id="u8BC6_u522B_u65B9_u5F0F"><a href="#u8BC6_u522B_u65B9_u5F0F" class="headerlink" title="识别方式"></a>识别方式</h2><h3 id="User-Agent_u8BC6_u522B"><a href="#User-Agent_u8BC6_u522B" class="headerlink" title="User-Agent识别"></a>User-Agent识别</h3><p>对于设备识别，主要方式是通过User-Agent识别，原理上比较简单，就是对User-Agent进行文本匹配或正则表达式匹配。这种方法的主要难度在于User-Agent词典文件的收集。</p>
<p>对于基于User-Agent的设备识别，完全可以在运行层进行，这里推荐一个GitHub上比较火的PHP设备识别库——<a href="http://mobiledetect.net/" target="_blank" rel="external">Mobile Detect</a>，GitHub地址是<a href="https://github.com/serbanghita/Mobile-Detect" target="_blank" rel="external">https://github.com/serbanghita/Mobile-Detect</a>。<a href="http://mobiledetect.net/" target="_blank" rel="external">Mobile Detect</a>是众多PHP<a href="https://github.com/serbanghita/Mobile-Detect#3rd-party-modules--submit-new" target="_blank" rel="external">框架或系统</a>所使用的识别库（如：Wordpress/Lavarel等）。</p>
<p><a href="http://mobiledetect.net/" target="_blank" rel="external">Mobile Detect</a>的使用方法很简单，只需包含文件，创建一个Mobile_Detect对象，就可以调用其丰富的库函数进行识别。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require_once</span> <span class="string">'Mobile_Detect.php'</span>;</span><br><span class="line"><span class="variable">$detect</span> = <span class="keyword">new</span> Mobile_Detect();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$detect</span>-&gt;isMobile()) &#123;</span><br><span class="line">    <span class="comment">// 我是移动端</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$detect</span>-&gt;isTablet()) &#123;</span><br><span class="line">    <span class="comment">// 我是平板</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$detect</span>-&gt;isiOS()) &#123;</span><br><span class="line">    <span class="comment">// 我是iOS端</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$detect</span>-&gt;version(<span class="string">'iPad'</span>); <span class="comment">// 获取iPad版本号</span></span><br></pre></td></tr></table></figure>
<p>更多Demo，请访问<a href="https://github.com/serbanghita/Mobile-Detect/wiki/Code-examples" target="_blank" rel="external">https://github.com/serbanghita/Mobile-Detect/wiki/Code-examples</a></p>
<h3 id="IP_u8BC6_u522B"><a href="#IP_u8BC6_u522B" class="headerlink" title="IP识别"></a>IP识别</h3><p>不过，针对国内的网络情况，有一个特殊的方式可以简化部分识别逻辑——IP识别。IP识别会针对国内几家移动电信运营商的入口IP进行识别，如果符合特征则会认为是移动设备，不再识别User-Agent。</p>
<p>这种方式，比起识别User-Agent更为高效简便，不用匹配庞大数量的字符串甚至是正则表达式。但也会有一个问题，就是通过手机热点访问的设备会被识别成手机。</p>
<h2 id="u8D34_u5427_u5E94_u7528"><a href="#u8D34_u5427_u5E94_u7528" class="headerlink" title="贴吧应用"></a>贴吧应用</h2><p>由于贴吧现在的架构对不同的服务分集群响应，因此目前需要在orp router层用nginx进行设备识别和分流，具体使用的是<a href="http://nginx.baidu.com/" target="_blank" rel="external">百度nginx技术小组</a>开发的<a href="http://gitlab.baidu.com/nginx/ngx-http-dna-module" target="_blank" rel="external">ngx_http_dna_module</a>设备识别nginx扩展，设备识别使用的是<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;### wise/adaption&#10;&#10;&#23545;&#20110;C/C++&#27169;&#22359;&#38656;&#35201;&#36827;&#34892;&#35774;&#22791;&#35782;&#21035;&#65292;&#20063;&#21487;&#20197;&#35843;&#29992;&#27492;&#27169;&#22359;&#36827;&#34892;&#35774;&#22791;&#31867;&#22411;&#35782;&#21035;&#12290;&#29992;&#27861;&#38750;&#24120;&#31616;&#21333;&#65292;&#21482;&#38656;&#35201;&#21021;&#22987;&#21270;&#24182;&#20256;&#20837;http headers&#20197;&#21450;ip&#22320;&#22336;&#65292;&#23601;&#21487;&#20197;&#36827;&#34892;User-Agent + IP&#30340;&#22797;&#21512;&#24335;&#35774;&#22791;&#35782;&#21035;&#12290;&#10;&#10;```cpp&#10;#include &#34;adaption.h&#34;&#10;#include &#34;adapt_dictentry.h&#34;&#10;#include &#34;adaptor_def.h&#34;&#10;&#10;// &#22768;&#26126;&#21644;&#21021;&#22987;&#21270;&#10;static Adaption_intf g_adaptor; &#10;g_adaptor.init(g_adaption_path);&#10;// &#35782;&#21035;&#20989;&#25968;&#10;is_mobile = g_adaptor.is_mobile_device(&#38;headers, (char *)ip);&#10;is_pad = g_adaptor.is_pad_device(&#38;headers);&#10;device_type = g_adaptor.get_device_type(&#38;headers, (char *)ip);</span><br></pre></td></tr></table></figure></p>
<p>SVN地址：/app/wise/ta/adaption<br>PS：<strong>光有代码程序是跑不起来的，记得找他们现在的负责人要一份最新的词典文件！</strong></p>
<h3 id="ngx_http_dna_module"><a href="#ngx_http_dna_module" class="headerlink" title="ngx_http_dna_module"></a>ngx_http_dna_module</h3><p><a href="http://gitlab.baidu.com/nginx/ngx-http-dna-module" target="_blank" rel="external">ngx_http_dna_module</a>为nginx http handler扩展，运行于<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;#### Directives&#10;&#10;* dna&#10;    * __Type__: flag&#10;    * __Context__: main, server, location&#10;    * __Default__: off&#10;    * __Description__: &#27169;&#22359;&#24320;&#20851;&#10;* dna_adapt_path&#10;    * __Type__: string&#10;    * __Context__: main, server, location&#10;    * __Default__: &#34;./&#34;&#10;    * __Description__: wise/adaption &#35789;&#20856;&#37197;&#32622;&#25991;&#20214;&#36335;&#24452;&#10;* dna_url_adaption&#10;    * __Type__: string&#10;    * __Context__: main, server, location&#10;    * __Default__: &#34;arg_device&#34;&#10;    * __Description__: &#36890;&#36807;url&#21442;&#25968;&#25351;&#23450;&#35774;&#22791;&#31867;&#22411;&#30340;&#21442;&#25968;&#21517;&#10;* dna_cookie_adaption&#10;    * __Type__: string&#10;    * __Context__: main, server, location&#10;    * __Default__: &#34;cookie_device&#34;&#10;    * __Description__: &#36890;&#36807;cookie&#25351;&#23450;&#35774;&#22791;&#31867;&#22411;&#30340;&#38190;&#21517;&#10;&#10;#### Variables&#10;&#10;* ```$dna_device</span><br></pre></td></tr></table></figure></p>
<pre><code>* __Type__: string
* __Values__: [pc | mobile | pad]
* __Description__: 变量为当前访问设备标识
</code></pre><h3 id="router_u914D_u7F6E_u89E3_u6790"><a href="#router_u914D_u7F6E_u89E3_u6790" class="headerlink" title="router配置解析"></a>router配置解析</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开关和配置信息</span></span><br><span class="line"><span class="title">dna</span>                 <span class="built_in">on</span>;</span><br><span class="line"><span class="title">dna_adapt_path</span>      <span class="string">"/home/work/nginx/conf/adaption"</span>;</span><br><span class="line"><span class="title">dna_url_adaption</span>    <span class="string">"tmp_device"</span>;</span><br><span class="line"><span class="title">dna_cookie_adaption</span> <span class="string">"tb_device"</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进行识别和跳转</span></span><br><span class="line"><span class="comment"># 例子：智能版frs</span></span><br><span class="line"><span class="comment"># 注：nginx不支持嵌套，所以判断方式比较诡异</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$dna_device</span> = <span class="string">"mobile"</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$mobile</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$request_uri</span> ~ <span class="string">"^/mo/q.*/m\?.*kw=|^/f\?.*kw=|^/mo/q.*/m?.*tn4=bdKSW.*sub4=|^/mo/q/topic_page/"</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$mobile</span> <span class="string">"<span class="variable">$&#123;mobile&#125;</span>frs"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> （<span class="variable">$mobile</span> ~ <span class="string">"1frs"</span>)</span><br><span class="line">&#123;</span><br><span class="line">    rewrite ^(.*) /mo_wowap_frs<span class="variable">$1</span> <span class="built_in">break</span>;</span><br><span class="line">    <span class="built_in">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># 最终引入mo_wowap_frs集群</span></span><br><span class="line"><span class="preprocessor"># ps：中间省略流量控制等部分内容，只用于示意</span></span><br><span class="line">location /mo_wowap_frs &#123;</span><br><span class="line">    proxy_pass http:<span class="comment">//tieba_mo_wowap_frs_server_name;</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="u5F15_u7528"><a href="#u5F15_u7528" class="headerlink" title="引用"></a>引用</h2><ol>
<li>百度贴吧数据平台</li>
<li>百度nginx使用手册 - 设备识别扩展说明(dna) <a href="http://nginx.baidu.com/book/nginx_user_manual/module/dna.html" target="_blank" rel="external">http://nginx.baidu.com/book/nginx_user_manual/module/dna.html</a></li>
</ol>

        </div>
    </div>
</article>

    </div>
    <footer class="footer">
        <div class="separate"><span class="separate-text">Tb Bravo</span></div>
        <ul class="footer-list clearfix">
            <li class="footer-item">
                <a href="mailto:tb_bravo@baidu.com">
                    <span class="glyphicon glyphicon-envelope" aria-hidden="true"></span>
                    <span class="footer-text">联系我们</span>
                </a>
            </li>
            <li class="footer-item">
                <a href="http://wiki.baidu.com/pages/viewpage.action?pageId=53026019" target="_blank">
                    <span class="glyphicon glyphicon-user" aria-hidden="true"></span>
                    <span class="footer-text">关于我们</span>
                </a>
            </li>
            <li class="footer-item">
                <a href="https://github.com/regrex/weekly" target="_blank">
                    <span class="glyphicon glyphicon-paperclip" aria-hidden="true"></span>
                    <span class="footer-text">页面源码</span>
                </a>
            </li>
            <li class="footer-item copyright">
                <span class="glyphicon glyphicon-copyright-mark" aria-hidden="true"></span>
                <span>2015 Baidu</span>
            </li>
        </ul>
    </footer>
    <script src="/bootstrap/js/jquery.min.js" type="text/javascript"></script>
<script src="/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    

</body>
</html>
